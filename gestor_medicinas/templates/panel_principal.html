{% extends 'base.html' %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/panel_principal.css' %}">
    <title>{% block title %}Panel principal{% endblock %}</title>
{% endblock %}

{% block body %}
<main class="noshow">

    <div class="cont_form_filtros">
        <form method="get" action="" class="formulario_filtros">

            <input type="text" name="filtro_medicina" placeholder="Buscar medicina..." value="{{ filtro_medicina }}" class="campo">

            <select name="filtro_presentacion" class="campo">
                <option value="">Todas presentaciones</option>
                {% for presentacion in presentaciones_activas %}
                    <option value="{{ presentacion.id_presentacion_medicamento }}"
                        {% if filtro_presentacion_id|stringformat:'s' == presentacion.id_presentacion_medicamento|stringformat:'s' %}
                            selected
                        {% endif %}>
                        {{ presentacion.desc_presentacion_medicamento }}
                    </option>
                {% endfor %}
            </select>


            <select name="filtro_ubicacion" class="campo">
                <option value="">Todas ubicaciones</option>
                {% for ubicacion in ubicaciones_activas %}
                    <option value="{{ ubicacion.id_ubicacion }}"
                        {% if filtro_ubicacion_id|stringformat:'s' == ubicacion.id_ubicacion|stringformat:'s' %}
                            selected
                        {% endif %}>
                        {{ ubicacion.desc_ubicacion }}
                    </option>
                {% endfor %}
            </select>


            <div class="cont_filtro_fecha">
                <label for="fecha_desde" class="label_fecha">Desde</label>
                <input type="date"
                       id="fecha_desde"
                       name="fecha_desde"
                       value="{{ fecha_desde }}"
                       class="campo">
            </div>

            <div class="cont_filtro_fecha">
                <label for="fecha_hasta" class="label_fecha">Hasta</label>
                <input type="date"
                       id="fecha_hasta"
                       name="fecha_hasta"
                       value="{{ fecha_hasta }}"
                       class="campo">
            </div>

            <button type="submit" class="boton_filtro">Filtrar</button>
        </form>
    </div>

    <div style="display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap: nowrap;">

        {# PAGINACIÓN: usamos filtros_qs generado en la vista SIN page #}
        {% if page_obj.has_previous %}
            {% if filtros_qs %}
                <a href="?page={{ page_obj.previous_page_number }}&{{ filtros_qs }}"
                   class="btn_paginacion">&lt;</a>
            {% else %}
                <a href="?page={{ page_obj.previous_page_number }}"
                   class="btn_paginacion">&lt;</a>
            {% endif %}
        {% else %}
            <span class="btn_paginacion_disabled">&lt;</span>
        {% endif %}

        <div class="panel">
            {% for medicina in page_obj %}
            <div class="medicina" style="border:1px solid #ccc; padding:10px; width:300px; box-sizing:border-box;">
                <div class="cont_imagen_medicina" style="text-align:center; margin-bottom:10px;">
                    {% if not medicina.imagen_medicina %}
                        <p class="texto_sin_img">Sin imagen</p>
                    {% else %}
                        {% if not medicina.imagen_existe %}
                            <p class="texto_img_perdida">Imagen perdida</p>
                        {% else %}
                            <img src="{{ medicina.imagen_medicina.url }}" alt="imagen medicina" class="imagen_medicina"/>
                        {% endif %}
                    {% endif %}
                </div>

                <div class="info_medicina">
                    <p class="desc_medicina">
                        <span class="span_desc_medicina">Medicina:</span> {{ medicina.medicina }}
                    </p>
                    <p class="desc_medicina">
                        <span class="span_desc_medicina">Ubicación:</span>
                        {% if medicina.ubicacion %}
                            {{ medicina.ubicacion.desc_ubicacion }}
                        {% else %}
                            Sin ubicación
                        {% endif %}
                    </p>
                    <p class="desc_medicina">
                        <span class="span_desc_medicina">Laboratorio:</span>
                         {{ medicina.laboratorio }}
                    </p>
                    <p class="desc_medicina">
                        <span class="span_desc_medicina">Cantidad:</span>
                         {{ medicina.cantidad }}
                    </p>

                    <p class="desc_medicina">
                        <span class="span_desc_medicina">Caducado:</span>
                        {% if medicina.caducado == True %}
                            Si
                        {% else %}
                            No
                        {% endif %}
                    </p>


                    <div class="caja_acciones" style="display:flex; gap:10px;">
                        <button type="button" class="btn_sumar" 
                                data-id="{{ medicina.id_medicina }}" 
                                data-desc="{{ medicina.medicina }}" 
                                data-cantidad="{{ medicina.cantidad }}">+</button>

                        <button type="button" class="btn_restar" 
                                data-id="{{ medicina.id_medicina }}" 
                                data-desc="{{ medicina.medicina }}" 
                                data-cantidad="{{ medicina.cantidad }}">-</button>

                        {% if filtros_qs %}
                            <a href="{% url 'ver_medicina' medicina.id_medicina %}?{{ filtros_qs }}" class="btn_ver">
                        {% else %}
                            <a href="{% url 'ver_medicina' medicina.id_medicina %}" class="btn_ver">
                        {% endif %}
                            <img src="{% static 'img/ico_ver.webp' %}" alt="icono" class="ico_boton">
                        </a>

                        {% if filtros_qs %}
                            <a href="{% url 'edicion_medicina' medicina.id_medicina %}?{{ filtros_qs }}" class="btn_editar">
                        {% else %}
                            <a href="{% url 'edicion_medicina' medicina.id_medicina %}" class="btn_editar">
                        {% endif %}
                            <img src="{% static 'img/ico_editar.webp' %}" alt="icono" class="ico_boton">
                        </a>

                        <button type="button" class="btn_borrar"
                                data-id="{{ medicina.id_medicina }}"
                                data-desc="{{ medicina.medicina }}">
                                <img src="{% static 'img/ico_borrar.webp' %}" alt="icono" class="ico_boton">
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
                <p class="texto_sin_medicinas">No hay medicinas que mostrar.</p>
            {% endfor %}
        </div>

        {% if page_obj.has_next %}
            {% if filtros_qs %}
                <a href="?page={{ page_obj.next_page_number }}&{{ filtros_qs }}"
                   class="btn_paginacion">&gt;</a>
            {% else %}
                <a href="?page={{ page_obj.next_page_number }}"
                   class="btn_paginacion">&gt;</a>
            {% endif %}
        {% else %}
            <span class="btn_paginacion_disabled">&gt;</span>
        {% endif %}
    </div>


    <div id="overlay_suma" class="form_overlay" style="display:none;">
        <div class="form_popup">
            <form id="form_suma" method="post" action="">
                {% csrf_token %}
                <p id="texto_suma"></p>

                <label for="cantidad_actual_suma">Cantidad actual: </label><br>
                <p id="cantidad_actual_suma" class="text_cantidad"></p>

                <input type="number" step="0.01" name="suma" id="input_suma" max="50000" min="0.01" required placeholder="Cantidad a sumar" class="campo_form_emergente1">
                <div>
                    <button type="submit" class="btn_form_emergente1">Guardar</button>
                    <button type="button" onclick="cerrarOverlay('overlay_suma')" class="btn_form_emergente2">Volver</button>
                </div>
            </form>
        </div>
    </div>

    <div id="overlay_resta" class="form_overlay">
        <div class="form_popup">
            <form id="form_resta" method="post" action="">
                {% csrf_token %}
                <p id="texto_resta"></p>

                <label for="cantidad_actual_resta">Cantidad actual:</label><br>
                <p id="cantidad_actual_resta" class="text_cantidad"></p>

                <input type="number" step="0.01" name="resta" id="input_resta" max="" min="0.01" required placeholder="Cantidad a restar" class="campo_form_emergente1">
                
                <div>
                    <button type="submit" class="btn_form_emergente1">Guardar</button>
                    <button type="button" onclick="cerrarOverlay('overlay_resta')" class="btn_form_emergente2">Volver</button>
                </div>
            </form>
        </div>
    </div>

    <div id="overlay_borrar" class="form_overlay" style="display:none;">
        <div class="form_popup">
            <form id="form_borrar" method="post" action="">
                {% csrf_token %}
                <p id="texto_borrar"></p>
                <div>
                    <button type="submit" class="btn_form_emergente1">Sí, borrar</button>
                    <button type="button" onclick="cerrarOverlay('overlay_borrar')" class="btn_form_emergente2">No, cancelar</button>
                </div>
            </form>
        </div>
    </div>
</main>

<script src="{% static 'js/emergentes.js' %}"></script>
{% endblock %}
