{% extends 'base.html' %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/registro_edicion.css' %}">
    <title>{% block title %}Editar Medicina{% endblock %}</title>
{% endblock %}

{% block body %}
<main>
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="form">
        {% csrf_token %}
        <h1 class="titulo2">Editar Medicina</h1>
        
        {% if medicina_obj.imagen_medicina %}
            <div class="contenedor_campo_img">
                <img src="{{ medicina_obj.imagen_medicina.url }}" alt="Imagen medicina" class="imagen_juguete" id="imagenPreview">
            </div>
        {% endif %}

        <div class="contenedor_campo_img">
            <label for="{{ form.imagen_medicina.id_for_label }}" class="custom-file-upload">
                Cambiar imagen {% if form.imagen_medicina.field.required %}*{% endif %}
            </label>

            <p class="PVM">{{ form.imagen_medicina }}</p>
            
            <span id="nombre_imagen">Ninguna imagen seleccionada</span>
            {% if form.imagen_medicina.errors %}
                <div class="errores">
                    {% for error in form.imagen_medicina.errors %}
                        <span class="errorSpan">{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="bloque_form_campos">
            <div class="cont_campos">
                <label for="{{ form.medicina.id_for_label }}">Medicina:</label>
                {{ form.medicina }}
                {% if form.medicina.errors %}
                    <div class="errores">
                        {% for error in form.medicina.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="cont_campos">
                <label for="{{ form.presentacion.id_for_label }}">Presentacion:</label>
                {{ form.presentacion }}
                {% if form.presentacion.errors %}
                    <div class="errores">
                        {% for error in form.presentacion.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="bloque_form_campos">
            <div class="cont_campos">
                <label for="{{ form.cantidad.id_for_label }}">Cantidad:</label>
                {{ form.cantidad }}
                {% if form.cantidad.errors %}
                    <div class="errores">
                        {% for error in form.cantidad.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="cont_campos">
                <label for="{{ form.laboratorio.id_for_label }}">Laboratorio:</label>
                {{ form.laboratorio }}
                {% if form.laboratorio.errors %}
                    <div class="errores">
                        {% for error in form.laboratorio.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="bloque_form_campos">
            <div class="cont_campos">
                <label for="{{ form.ubicacion.id_for_label }}">Ubicacion:</label>
                {{ form.ubicacion }}
                {% if form.ubicacion.errors %}
                    <div class="errores">
                        {% for error in form.ubicacion.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="cont_campos">
                <label for="{{ form.anaquel.id_for_label }}">Anaquel:</label>
                {{ form.anaquel }}
                {% if form.anaquel.errors %}
                    <div class="errores">
                        {% for error in form.anaquel.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="bloque_form_campos">
            <div class="cont_campos">
                <label for="{{ form.fecha_caducidad.id_for_label }}">Fecha caducidad:</label>
                {{ form.fecha_caducidad }}
                {% if form.fecha_caducidad.errors %}
                    <div class="errores">
                        {% for error in form.fecha_caducidad.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="bloque_form_campos">
            <div class="cont_campos2">
                <label for="{{ form.descripcion.id_for_label }}">Descripcion:</label>
                {{ form.descripcion }}
                {% if form.descripcion.errors %}
                    <div class="errores">
                        {% for error in form.descripcion.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="bloque_form_campos">
            <div class="cont_campos2">
                <label for="{{ form.observaciones.id_for_label }}">Observaciones:</label>
                {{ form.observaciones }}
                {% if form.observaciones.errors %}
                    <div class="errores">
                        {% for error in form.observaciones.errors %}
                            <span class="errorSpan">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="caja_botones">
            <button type="submit" class="boton_crear">Guardar Cambios</button>
            <a href="{% url 'panel_principal' %}?{{ request.GET.urlencode }}" class="boton_volver">Volver</a>
        </div>
    </form>

    <script>
        const inputImagen = document.getElementById('{{ form.imagen_medicina.id_for_label }}');
        const spanNombre = document.getElementById('nombre_imagen');
        const imagenPreview = document.getElementById('imagenPreview');
        
        if (inputImagen && spanNombre) {
            inputImagen.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    spanNombre.textContent = this.files[0].name;
                    
                    if (imagenPreview) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imagenPreview.src = e.target.result;
                            imagenPreview.style.display = 'block';
                        }
                        reader.readAsDataURL(this.files[0]);
                    }
                } else {
                    spanNombre.textContent = 'Ninguna imagen seleccionada';
                }
            });
        }
    </script>
</main>
{% endblock %}
